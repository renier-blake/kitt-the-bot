<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>KITT Portal - Logs</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      background: #0d1117;
      color: #c9d1d9;
      font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
      font-size: 13px;
      line-height: 1.5;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      background: #161b22;
      border-bottom: 1px solid #30363d;
      padding: 12px 16px;
      display: flex;
      align-items: center;
      gap: 16px;
      flex-shrink: 0;
    }

    .logo {
      font-size: 18px;
      font-weight: 600;
      color: #58a6ff;
    }

    .status {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #f85149;
    }

    .status-dot.connected {
      background: #3fb950;
    }

    .controls {
      display: flex;
      gap: 8px;
      margin-left: auto;
    }

    button, select {
      background: #21262d;
      border: 1px solid #30363d;
      color: #c9d1d9;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 12px;
      cursor: pointer;
      font-family: inherit;
    }

    button:hover, select:hover {
      background: #30363d;
    }

    button.active {
      background: #238636;
      border-color: #238636;
    }

    button.pause {
      background: #da3633;
      border-color: #da3633;
    }

    #logs {
      flex: 1;
      overflow-y: auto;
      padding: 8px 0;
    }

    .log-entry {
      padding: 4px 16px;
      border-left: 3px solid transparent;
      display: flex;
      gap: 12px;
    }

    .log-entry:hover {
      background: #161b22;
    }

    .log-entry.think-loop {
      border-left-color: #58a6ff;
    }

    .log-entry.agent {
      border-left-color: #a371f7;
    }

    .log-entry.scheduler {
      border-left-color: #f0883e;
    }

    .log-entry.error {
      border-left-color: #f85149;
      background: rgba(248, 81, 73, 0.1);
    }

    .log-entry.warn {
      border-left-color: #d29922;
      background: rgba(210, 153, 34, 0.1);
    }

    .log-entry.system {
      border-left-color: #3fb950;
      color: #3fb950;
    }

    .log-time {
      color: #8b949e;
      flex-shrink: 0;
      width: 85px;
    }

    .log-content {
      flex: 1;
      word-break: break-word;
      white-space: pre-wrap;
    }

    .log-content .prefix {
      font-weight: 600;
    }

    .log-content .prefix.think-loop { color: #58a6ff; }
    .log-content .prefix.agent { color: #a371f7; }
    .log-content .prefix.scheduler { color: #f0883e; }
    .log-content .prefix.telegram { color: #3fb950; }

    .json-key { color: #7ee787; }
    .json-string { color: #a5d6ff; }
    .json-number { color: #79c0ff; }

    .reasoning-block {
      margin: 8px 0;
      padding: 12px;
      background: #161b22;
      border-radius: 6px;
      border: 1px solid #30363d;
    }

    .reasoning-block h4 {
      color: #58a6ff;
      margin-bottom: 8px;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .action-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
      margin-left: 8px;
    }

    .action-badge.ok {
      background: #238636;
      color: white;
    }

    .action-badge.message {
      background: #58a6ff;
      color: white;
    }

    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: #8b949e;
    }

    .empty-state .icon {
      font-size: 48px;
      margin-bottom: 16px;
    }

    footer {
      background: #161b22;
      border-top: 1px solid #30363d;
      padding: 8px 16px;
      font-size: 11px;
      color: #8b949e;
      display: flex;
      justify-content: space-between;
    }

    /* Scrollbar styling */
    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-track {
      background: #0d1117;
    }

    ::-webkit-scrollbar-thumb {
      background: #30363d;
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #484f58;
    }
  </style>
</head>
<body>
  <header>
    <div class="logo">KITT Portal</div>
    <div style="display:flex;gap:8px;margin-left:8px;">
      <a href="index.html" style="color:#fff;text-decoration:none;padding:6px 12px;border-radius:6px;background:#238636;border:1px solid #238636;font-size:12px;font-family:system-ui;">Logs</a>
      <a href="database.html" style="color:#c9d1d9;text-decoration:none;padding:6px 12px;border-radius:6px;background:#21262d;border:1px solid #30363d;font-size:12px;font-family:system-ui;">Database</a>
      <a href="docs.html" style="color:#c9d1d9;text-decoration:none;padding:6px 12px;border-radius:6px;background:#21262d;border:1px solid #30363d;font-size:12px;font-family:system-ui;">Docs</a>
    </div>
    <div class="status">
      <div class="status-dot" id="statusDot"></div>
      <span id="statusText">Connecting...</span>
    </div>
    <div class="status" id="kittStatus" style="margin-left:8px;padding:4px 10px;border-radius:6px;background:#21262d;border:1px solid #30363d;">
      <span id="kittStatusText">Loading...</span>
    </div>
    <div class="controls">
      <select id="filter">
        <option value="all">All Logs</option>
        <option value="think-loop">Think Loop</option>
        <option value="agent">Agent</option>
        <option value="error">Errors</option>
        <option value="structured">Structured</option>
      </select>
      <button id="autoScrollBtn" class="active">Auto-scroll</button>
      <button id="pauseBtn">Pause</button>
      <button id="clearBtn">Clear</button>
    </div>
  </header>

  <div id="logs">
    <div class="empty-state" id="emptyState">
      <div class="icon">...</div>
      <div>Waiting for logs...</div>
    </div>
  </div>

  <footer>
    <span id="logCount">0 logs</span>
    <span>KITT Portal v1.0</span>
  </footer>

  <script>
    const logsContainer = document.getElementById('logs');
    const emptyState = document.getElementById('emptyState');
    const statusDot = document.getElementById('statusDot');
    const statusText = document.getElementById('statusText');
    const filterSelect = document.getElementById('filter');
    const autoScrollBtn = document.getElementById('autoScrollBtn');
    const pauseBtn = document.getElementById('pauseBtn');
    const clearBtn = document.getElementById('clearBtn');
    const logCountEl = document.getElementById('logCount');

    let autoScroll = true;
    let paused = false;
    let logCount = 0;
    let pendingLogs = [];
    let ws = null;
    let reconnectAttempts = 0;

    function formatTime(ts) {
      const d = new Date(ts);
      return d.toLocaleTimeString('nl-NL', {
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        timeZone: 'Europe/Amsterdam'
      });
    }

    function formatJson(str) {
      try {
        const obj = JSON.parse(str);
        return Object.entries(obj)
          .map(([k, v]) => `<span class="json-key">${k}</span>: <span class="${typeof v === 'number' ? 'json-number' : 'json-string'}">${JSON.stringify(v)}</span>`)
          .join(', ');
      } catch {
        return escapeHtml(str);
      }
    }

    function escapeHtml(str) {
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    function formatContent(content, source) {
      let html = escapeHtml(content);

      // Highlight prefixes
      html = html.replace(/\[think-loop\]/g, '<span class="prefix think-loop">[think-loop]</span>');
      html = html.replace(/\[agent\]/g, '<span class="prefix agent">[agent]</span>');
      html = html.replace(/\[scheduler\]/g, '<span class="prefix scheduler">[scheduler]</span>');
      html = html.replace(/\[telegram\]/g, '<span class="prefix telegram">[telegram]</span>');

      // Format JSON lines
      if (content.startsWith('{"ts":')) {
        html = formatJson(content);
      }

      // Format REASONING/ACTION blocks
      if (content.includes('REASONING:') || content.includes('ACTION:')) {
        const reasoningMatch = content.match(/REASONING:\s*(.+?)(?=ACTION:|$)/s);
        const actionMatch = content.match(/ACTION:\s*(\w+)/);

        if (reasoningMatch || actionMatch) {
          let blockHtml = '<div class="reasoning-block">';
          if (reasoningMatch) {
            blockHtml += `<h4>Reasoning</h4><div>${escapeHtml(reasoningMatch[1].trim())}</div>`;
          }
          if (actionMatch) {
            const action = actionMatch[1].toUpperCase();
            const badgeClass = action === 'OK' ? 'ok' : 'message';
            blockHtml += `<span class="action-badge ${badgeClass}">${action}</span>`;
          }
          blockHtml += '</div>';
          return blockHtml;
        }
      }

      return html;
    }

    function addLogEntry(entry) {
      if (emptyState) {
        emptyState.remove();
      }

      const filter = filterSelect.value;
      const matchesFilter = filter === 'all' ||
        (filter === 'error' && entry.level === 'error') ||
        (entry.source && entry.source === filter);

      const div = document.createElement('div');
      div.className = `log-entry ${entry.source || ''} ${entry.level}`;
      div.dataset.source = entry.source || '';
      div.dataset.level = entry.level;

      if (!matchesFilter) {
        div.style.display = 'none';
      }

      div.innerHTML = `
        <span class="log-time">${formatTime(entry.ts)}</span>
        <span class="log-content">${formatContent(entry.content, entry.source)}</span>
      `;

      logsContainer.appendChild(div);
      logCount++;
      logCountEl.textContent = `${logCount} logs`;

      if (autoScroll && !paused) {
        logsContainer.scrollTop = logsContainer.scrollHeight;
      }
    }

    function applyFilter() {
      const filter = filterSelect.value;
      const entries = logsContainer.querySelectorAll('.log-entry');

      entries.forEach(entry => {
        const source = entry.dataset.source;
        const level = entry.dataset.level;
        const matchesFilter = filter === 'all' ||
          (filter === 'error' && level === 'error') ||
          (source && source === filter);

        entry.style.display = matchesFilter ? '' : 'none';
      });
    }

    function connect() {
      const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
      const wsUrl = `${protocol}//${window.location.host}/ws`;

      ws = new WebSocket(wsUrl);

      ws.onopen = () => {
        statusDot.classList.add('connected');
        statusText.textContent = 'Connected';
        reconnectAttempts = 0;
      };

      ws.onmessage = (event) => {
        try {
          const entry = JSON.parse(event.data);
          if (paused) {
            pendingLogs.push(entry);
          } else {
            addLogEntry(entry);
          }
        } catch (e) {
          console.error('Failed to parse log entry:', e);
        }
      };

      ws.onclose = () => {
        statusDot.classList.remove('connected');
        statusText.textContent = 'Disconnected';

        // Reconnect with backoff
        reconnectAttempts++;
        const delay = Math.min(1000 * Math.pow(2, reconnectAttempts), 30000);
        setTimeout(connect, delay);
      };

      ws.onerror = () => {
        statusText.textContent = 'Connection error';
      };
    }

    // Event listeners
    filterSelect.addEventListener('change', applyFilter);

    autoScrollBtn.addEventListener('click', () => {
      autoScroll = !autoScroll;
      autoScrollBtn.classList.toggle('active', autoScroll);
      if (autoScroll) {
        logsContainer.scrollTop = logsContainer.scrollHeight;
      }
    });

    pauseBtn.addEventListener('click', () => {
      paused = !paused;
      pauseBtn.classList.toggle('pause', paused);
      pauseBtn.textContent = paused ? 'Resume' : 'Pause';

      if (!paused && pendingLogs.length > 0) {
        pendingLogs.forEach(addLogEntry);
        pendingLogs = [];
      }
    });

    clearBtn.addEventListener('click', () => {
      logsContainer.innerHTML = '';
      logCount = 0;
      logCountEl.textContent = '0 logs';
    });

    // KITT Status polling
    const kittStatusEl = document.getElementById('kittStatusText');
    const kittStatusContainer = document.getElementById('kittStatus');

    async function updateKittStatus() {
      try {
        const res = await fetch('/api/status');
        const data = await res.json();

        kittStatusEl.textContent = data.sleep.display;

        if (data.sleep.isSleeping) {
          kittStatusContainer.style.background = '#21262d';
          kittStatusContainer.style.borderColor = '#da3633';
          kittStatusEl.style.color = '#f0883e';
        } else {
          kittStatusContainer.style.background = '#21262d';
          kittStatusContainer.style.borderColor = '#238636';
          kittStatusEl.style.color = '#3fb950';
        }
      } catch (e) {
        kittStatusEl.textContent = '⚠️ Status unavailable';
      }
    }

    // Update status every 30 seconds
    updateKittStatus();
    setInterval(updateKittStatus, 30000);

    // Start connection
    connect();
  </script>
</body>
</html>
